---
title: "Adult Mortality in the Metropolis of London 1100–1850"
subtitle: "Supplement: Code structure, data source and processing"
author: 
 - Nils Müller-Scheeßel^[Institute for Pre- and Proto History - Kiel University nils.mueller-scheessel@ufg.uni-kiel.de]
 - Katharina Fuchs^[Institute of Clinical Molecular Biology - Kiel University, k.fuchs@ikmb.uni-kiel.de]
 - Christoph Rinne^[Institute for Pre- and Proto History - Kiel University, crinne@ufg.uni-kiel.de]
date: "`r format(Sys.time(), '%d. %B %Y')`"
license: "CC-BY 4.0"
header-includes:
  #\renewcommand{\contentsname}{Inhalt}
  #\renewcommand{\figurename}{Abb.}
  #\renewcommand{\tablename}{Tab.}
papersize: a4
output:
  pdf_document:
    number_sections: true
    toc: true
    toc_depth: 2
    df_print: kable
    extra_dependencies: ["flafter"]
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 2
    toc_float: true
    number_sections: true
#  html_notebook:
#        code_folding: hide
knit rmdfig_caption: true
urlcolor: blue
link-citations: true # make citations hyperlinks
linkcolor: blue
bibliography: References.bib
csl: offa.csl
---

```{r knitr global options, include=FALSE}
# Global options for knitr
knitr::opts_chunk$set(echo=TRUE, fig.align="center")
```

# Prerequisites {-}

The calculations were made in R using R-Studio. The structure of the code is essentially based on the structure of the text. The raw code is in the file ```order_of_code.R```. The file extended with Markdown is ```order_of_code-doc.RMD``` and the file ```order_of_code-doc.pdf``` is generated from it.

The code makes extensive use of the function ```source``` to call external code. Thus, the main part of the code remains slim, well structured and readable. 

Note: The base path for rmd files is the folder in which they are located, not the r-project. Consequently, ```order_of_code.R``` and ```order_of_code-doc.RMD``` are both located in the root folder of the project.

Install required packages, set some options and link the sources for the helper functions. 

Remark: The current version of osmplotr has to be installed from github using ```devtools::install_github ("ropensci/osmplotr")```. 

```{r Packages and sources, echo=TRUE}
require(pacman) || install.packages("pacman")
pacman::p_load(dplyr, fitdistrplus, flexsurv, ggplot2, gridExtra, kableExtra,
               mortAAR, nlme, osmplotr, reshape2, rgdal, HMDHFDplus, Metrics,
               svMisc, tibble, tidyr, cowplot, MortalityLaws, rio,
               coda, rjags, runjags, demogR, sf, rnaturalearth, readxl,
               ggrepel)

options(scipen = 999)
options(dplyr.summarise.inform = FALSE)

source("./functions/bayes_cat_poisson.R")
source("./functions/gomp_MLE.R")
source("./functions/gomp_MLE_adapted.R")
source("./functions/gomp_MLE_interval.R")
source("./functions/gomp_anthr_age.R")
source("./functions/gomp_anthr_age_r.R")
source("./functions/gomp_bayes_known_age.R")
source("./functions/gomp_known_age_r.R")
source("./functions/helper_functions.R")
source("./functions/lt_MC.R")
source("./functions/lt_MC_Gomp.R")
RNGkind("L'Ecuyer-CMRG") # conservative random number generator to avoid periodicity
```
Important for saving time:  Decide to run extensive code anew (app. 6 h +). In addition, you can set the folder for preprocessed files.

```{r rund code anew, echo=TRUE}
runCodeNew <- FALSE
#runCodeNew <- TRUE

saveFileDir = "preprocessed_files"
if (saveFileDir %in% list.files(getwd())) 
 {}else{
	dir.create(file.path(".", saveFileDir), showWarnings = FALSE )
 }

```

\newpage
# Chapter 01 Introduction

Figure 1: Exemplary life table curves generated by Gompertz functions with different $\beta$ parameters.

```{r Fig. 1: Gompertz distribution, echo=TRUE, warning=FALSE}
source("./chapter_01_introduction/gompertz_distribution.R")
```

\newpage
# Chapter 02 Materials and methods

Figure 3: Hazard curve for HMD UK data of the year 1841.

```{r Fig. 3: Hazard curve, echo=TRUE, warning=FALSE}
source("./chapter_02_materials_and_methods/hazard_curve.R")
```

\newpage
# Chapter 03 Data

Figure 4: Major cemeteries in Greater London 1100–1850 used in the present study. 

```{r Fig. 4: Map of London, echo=TRUE, warning=FALSE}
source("./chapter_03_data/London_places.R") 
```

\newpage
Figure 5: Population development of London, compiled from @ref_268519, 39 table 1; @ref_90775, 41; 179 table 5.7; @ref_115940, 655--657.

```{r Fif. 5: Population development, echo=TRUE, warning=FALSE}
source("./chapter_03_data/London_population.R")
grid::grid.newpage()
grid::grid.draw(rbind(london_pop1, london_pop2))
```

Footnote 6: Re-calculation of population increase rates of London from @ref_278969.
Calculated in ./chapter_03_data/London_population.R

```{r Footnote 6: Razzell/Spence 2007, warning=FALSE}
knitr::kable(razz_df, caption = "Re-calculation of population increase rates of London from Razzell/Spence 2007.")%>%
  kableExtra::kable_styling(latex_options = "HOLD_position")
```

\newpage
# Chapter 04 Results

Preprocessing of data used in figure 6: Estimated modal ages.

## Historical life tables

### Written sources and pre-processing

**Basic statistics**

The data is referenced and aggregated in "./chapter_04_results/historical_lifetables.R". In this file, all records from individual preprocessing files located in "./liftables_preprocessed/" are ```sourced```.  The corresponding data files are stored in "./data/".

English_Peers.R, russell.txt, Source: @ref_45151, table 2

```{r Basic statistics English Peers, warning=FALSE}
source("./chapter_04_results/historical_lifetables.R")
kable(peers_ranges, caption = "English Peers") %>%
  kableExtra::kable_styling(latex_options = "HOLD_position")
```

Medieval_England.R, Christ_church_monks.txt, Source: @ref_54763, 28 table 2

```{r Basic statistics Christ Church monks, warning=FALSE}
kable(monks_ranges, caption = "Christ Church monks") %>%
  kableExtra::kable_styling(latex_options = "HOLD_position")
```

London_1728_1840.R, Mortality_bills_1728_1840.txt, Source: @ref_301236, 304 Table 6.5; > 100 years and < 1 year collapsed

```{r Basic statistics Mortality bills 1728-1840 age modes, warning=FALSE}
kable(london_1728_1840_ranges, 
      caption = "London Mortality bills 1728-1840.") %>%
  kableExtra::kable_styling(latex_options = "HOLD_position")
```

```{r Basic statistics Mortality bills 1728-1840 rate, warning=FALSE}
kable(london_1728_1840_ranges_r, 
      caption = "London Mortality bills 1728-1840, corrected for population growth.") %>%
  kableExtra::kable_styling(latex_options = "HOLD_position")
```

London_1841_raw_all.R, London_1841_raw.txt, Source: @ref_94043, 19 table q.

```{r Basic statistics census data for London from 1841, warning=FALSE}
kable(London_1841_ranges, 
      caption = "Census data for London from 1841.") %>%
  kableExtra::kable_styling(latex_options = "HOLD_position")
```

English_Mortality.R, wrigley_et_al_1997_england_1640-1809.txt, Source: @ref_73169, 290 table 6.19

```{r Basic statistics English mortality, warning=FALSE}
kable(eng_mort_ranges, 
      caption = "English mortality data.") %>%
  kableExtra::kable_styling(latex_options = "HOLD_position")
```

HMD_UK_ranges.R

The data from the Human Mortality Database (https://mortality.org/) were retrieved with a personal account using the R package HMDHFDplus. Therefore, we only provide the processed data here.  

```{r Basic statistics HMD UK, warning=FALSE}
kable(HMD_UK_ranges, caption = "Human Mortality Database UK.") %>%
  kableExtra::kable_styling(latex_options = "HOLD_position")
```

Marylebone.R

Data are hard coded in the code. Sources: @ref_221997, 97--103 table 32 (St Marylebone); @ref_242052, 81 (St Marylebone north of Paddington street)

```{r Basic statistics Marylebone, warning=FALSE}
source("./lifetables_processing/Marylebone.R")
kable(Marylebone_ranges, caption = "St Marylebone.") %>%
  kableExtra::kable_styling(latex_options = "HOLD_position")
```

**Extended statistics**

```{r Etended statistics written sources, warning=FALSE}
kable(peers_result, caption = "English Peers.") %>%
  kableExtra::kable_styling(latex_options = c("HOLD_position","scale_down"))
kable(monks_result, caption = "Christ Church monks.") %>%
  kableExtra::kable_styling(latex_options = c("HOLD_position","scale_down"))
kable(london_1728_1840_result, 
      caption = "London Mortality bills 1728-1840.") %>%
  kableExtra::kable_styling(latex_options = c("HOLD_position","scale_down"))
kable(london_1728_1840_result_r, 
      caption = "London Mortality bills 1728-1840, corrected for population growth.") %>%
  kableExtra::kable_styling(latex_options = c("HOLD_position","scale_down"))
kable(London_1841_result, 
      caption = "Census data for London from 1841.") %>%
  kableExtra::kable_styling(latex_options = c("HOLD_position","scale_down"))
kable(eng_mort_result, caption = "English mortality data.") %>%
  kableExtra::kable_styling(latex_options = c("HOLD_position","scale_down"))
kable(HMD_UK_result, caption = "Human Mortality Database UK.") %>%
  kableExtra::kable_styling(latex_options = c("HOLD_position","scale_down"))
```

## London cemeteries

The data is manly hard coded in the file ./chapter_04_results/Wellcome_DB.R. 

Only St. Bride's crypt is excluded but available from the Museum of London upon request. For general information: [https://www.museumoflondon.org.uk](https://www.museumoflondon.org.uk) go for: Collections > Archaeology at the Museum of London > Wellcome Osteological Research Database > St. Bride's Church Fleet Street. 
If runCodeNew == TRUE  the file ./lifetables_processing/stbrides_crypt.R will ask for the location of the retrieved dataset (Excel sheet) and process the data. In any other case pre-processed data will be loaded. 

```{r cemeteries data pre-processed, warning=FALSE}
source("./lifetables_processing/stbrides_crypt.R")
source("./chapter_04_results/Wellcome_DB.R")
```

### Pre-processing and extended results

```{r wellcome results, warning=FALSE}
kable(wellcome_result, caption = "London cemeteries data") %>%
  kableExtra::kable_styling(latex_options = c("HOLD_position","scale_down"))
kable(wellcome_result_r, caption = "London cemeteries data, rate") %>%
  kableExtra::kable_styling(latex_options = c("HOLD_position","scale_down"))
```


## Modal ages from historical and osteological data

Figure 6: Modal ages from historical and osteological data

```{r figure 6 modal ages plot, fig.height=8.5, fig.width=11, echo=TRUE, warning=FALSE}
source("./chapter_04_results/english_wellcome.R")
plot(modal_ages_plot)
```

Table 2: Overview of modelled osteological data from London cemeteries

The data overview is build during pre-processing in ./chapter_04_results/Wellcome_DB.R and saved to a textfile (sep = \\t).

wellcome_overview_all
```{r wellcome_overview_all, warning=FALSE}
kable(wellcome_overview_all, caption = "London cemeteries overview") %>%
  kableExtra::kable_styling(latex_options = c("HOLD_position","scale_down"))
```

Figure 7: St. Bride's Crypt. Density of actual ages and Bayesian model of Gompertz distribution of actual ages and osteological estimates (without correction for population growth).

The plot is build in ./lifetables_processing/stbrides_crypt.R within the if-statement on runCodeNew (s. data limitations above).

```{r figure 7 St. Bride Crypt, fig.height=3, fig.width=5.5, warning=FALSE}
plot(stbrides_crypt_plot)
```

Figure 8: Simulation of population increase with known age-at-death and Maximum Likelihood Estimation (MLE) (top four) and osteological estimates, Bayesian model and including rate of increase (bottom four).

```{r Simulation of population increase, warning=FALSE}
source("./chapter_04_results/simulations_pop_incr_run.R")
```

\newpage
# Supplements

The chapter 'Supporting informations' provides details about the London cemeteries included in the study. 

## The Coale & Demeny life tables

Calculation of the lowest $\beta$-value for any of their life tables is 0.0391 (the female table "West", level 1).

```{r Coale and Demeny life tables beta-value, warning=FALSE}
source("./chapter_supplement/coale_demeny_life_tables_gompertz.R")
min(gompertz_df$Gompertz_shape)
```
## Gompertz parameters

Simulations for evaluation of algorithms for retrieving Gompertz parameters. 
The file simulations_run.R provides various tests and plots from the evaluation process.
Plot the results of methods with known age-at-death.

```{r Simulations retrieving Gompertz parameters, warning=FALSE}
source("./chapter_supplement/simulations_run.R")
gridExtra::grid.arrange(grobs = plot_list_shapes, ncol = 3)
```




\newpage
# References
