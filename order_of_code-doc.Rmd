---
title: "Adult Mortality in the Metropolis of London 100–1850"
subtitle: "A Bayesian View from Osteological Data"
author: 
 - Nils Müller-Scheeßel^[Institute for Pre- and Proto History - Kiel University nils.mueller-scheessel@ufg.uni-kiel.de]
 - Katharina Fuchs^[Institute of Clinical Molecular Biology - Kiel University, k.fuchs@ikmb.uni-kiel.de]
 - Christoph Rinne^[Institute for Pre- and Proto History - Kiel University, crinne@ufg.uni-kiel.de]
date: "`r format(Sys.time(), '%d. %B %Y')`"
license: "CC-BY 4.0"
header-includes:
  #\renewcommand{\contentsname}{Inhalt}
  #\renewcommand{\figurename}{Abb.}
  #\renewcommand{\tablename}{Tab.}
papersize: a4
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 2
    toc_float: true
    number_sections: true
  pdf_document:
    number_sections: true
    toc: true
    toc_depth: 2
    df_print: kable
#  html_notebook:
#        code_folding: hide
knit rmdfig_caption: true
urlcolor: blue
link-citations: true # make citations hyperlinks
linkcolor: blue
---

```{r knitr global options, include=FALSE}
# Global options for knitr
knitr::opts_chunk$set(echo = TRUE, fig.align = "center")
```

# Prerequisites

Install required packages, set some options and link the sources for the helper functions. 

**Please note**: Relative paths in the original code, not for documentation purposes, references the workspace, e.g. "./helper_functions.R". Where as in Rmd-files the file location is the root for relative paths, e.g. "../helper_functions.R".  


```{r echo=FALSE}
require(pacman) || install.packages("pacman")
pacman::p_load(dplyr, fitdistrplus, flexsurv, ggplot2, gridExtra, kableExtra,
               mortAAR, nlme, osmplotr, reshape2, rgdal, HMDHFDplus, Metrics,
               svMisc, tibble, tidyr, cowplot, MortalityLaws, rio,
               coda, rjags, runjags, demogR, sf, rnaturalearth, readxl,
               ggrepel)

options(scipen = 999)
options(dplyr.summarise.inform = FALSE)

source("./functions/bayes_cat_poisson.R")
source("./functions/gomp_MLE.R")
source("./functions/gomp_MLE_adapted.R")
source("./functions/gomp_MLE_interval.R")
source("./functions/gomp_anthr_age.R")
source("./functions/gomp_anthr_age_r.R")
source("./functions/gomp_bayes_known_age.R")
source("./functions/gomp_known_age_r.R")
source("./functions/helper_functions.R")
source("./functions/lt_MC.R")
source("./functions/lt_MC_Gomp.R")
RNGkind("L'Ecuyer-CMRG") # conservative random number generator to avoid periodicity
```
Important for saving time:  Decide to run extensive code anew (app. 6 h +). In addition you can set the folder for preprocessed files

```{r echo=TRUE}
runCodeNew <- FALSE
#runCodeNew <- TRUE

saveFileDir = "preprocessed_files"
if (saveFileDir %in% list.files(getwd())) 
 {}else{
	dir.create(file.path(".", saveFileDir), showWarnings = FALSE )
 }

```

The code makes extensive use of the function source to call external code. Thus the main part of the code remains slim, well structured and readable. 
Remark: The base path for rmd-files is the folder where it is located, so '../' changes to the project folder.

# Chapter 01 Introduction

Figure 1: Gompertz.

```{r }
source("./chapter_01_introduction/gompertz_distribution.R")
```

# Chapter 02 Materials and methods

Figure 3 Hazard

```{r }
source("./chapter_02_materials_and_methods/hazard_curve.R")
```

# Chapter Data

## computing the inaccuracy of resampled "age estimations"

```{r }
if (runCodeNew) {
lt_bias <- lt.sampling(1000, n_min = 50, n_max = 500, b_min = 0.02, b_max = 0.1, error_range = 15)
save(lt_bias, file = file.path("..", saveFileDir, "lt_bias.Rdata"))  
} else {
  load(file = file.path("..", saveFileDir, "lt_bias.Rdata")) 
}
mean(lt_bias$lt_inaccuracy)
```

## show map of London with sites

```{r }
source("./London_places.R") # not working yet
```

# Chapter Results

## London population

```{r }
source("./London_population.R")
do.call(gridExtra::grid.arrange, c(london_pop_list, ncol = 1) )
```

### Simulation of population increase

```{r }
source("./simulations_pop_incr_run.R")
do.call(gridExtra::grid.arrange, c(lt_sim_list, ncol = 6) )
```

## Historical Data
### Written sources, pre-processed

```{r }
source("./historical_lifetables.R")
Peers_ranges
monks_ranges
London_1758_ranges
London_1841_ranges
eng_mort_ranges
HMD_UK_ranges
```

## Wellcome Data

```{r }
source("./lifetables_processing/stbrides_crypt.R")
source("./lifetables_processing/Merton_Priory.R")
source("./Wellcome_DB.R") # can take a while
```

## St. Bride's crypt data, comparison of known age and osteological estimates

```{r }
gridExtra::grid.arrange(stbrides_crypt_plot,
                        bottom = "black = density of actual ages (bandwidth = 5)\n blue = Gompertz distribution of actual ages\n red = Gompertz distribution of osteological estimates")
```

## show overview of Wellcome data

```{r }
wellcome_overview 
# to do: sample size
```

# Chapter Discussion

## modal ages from historical and osteological data

```{r }
english_wellcome <- rbind(english_mortality_prep, wellcome_prep)
english_wellcome$data <- factor(english_wellcome$data, levels = unique(english_wellcome$data))

english_wellcome_plot <- ggplot(english_wellcome, aes(colour = data, shape = source) ) +  
    ylab("modal age")  + xlab("year") + ylim(10, 70) +
  geom_errorbar(aes(x = (start + end) / 2, y = M, ymin = HDIlow, ymax=  HDIhigh), width=0, colour = "dark grey") +
  geom_errorbarh(aes(x = (start + end) / 2, y = M, xmax = start, xmin = end, height = 0), colour = "dark grey") +
  geom_point(aes(x = as.numeric(substr(year, 2, 5)), y = M), size= 3 )+ 
  geom_point(aes(x = (start + end) / 2, y = M), size= 3) + guides(size = "none")
suppressWarnings(print(english_wellcome_plot))
```

# Chapter Supplement

## one complete Bayesian example, with different settings

```{r }
set.seed(1312)
source("./bayes_complete.R") # can take a few minutes
```
```{r }
bayes_complete_table

source("./simulations_run.R")
```

## plot of results of methods with known age-at-death

```{r }
do.call(gridExtra::grid.arrange, plot_list_shapes)
```

## plot of difference between expected and observed value

```{r }
do.call(gridExtra::grid.arrange, plot_list_diff)
```

## table of RMSEs

```{r }
rmse_result[order(rmse_result$RMSE) ,]
```

## plot of results of methods with estimated age-at-death

```{r }
do.call(gridExtra::grid.arrange, plot_list_estim_shapes)
```

## table of RMSEs

```{r }
rmse_estim_result[order(rmse_estim_result$RMSE) ,]
```

## plot for Bayesian model of difference

```{r }
do.call(gridExtra::grid.arrange, c(plot_list_bayes_diff, ncol = 2) )
```

## Written sources, pre-processed

```{r }
source("./historical_lifetables.R")
Peers_result
Landers_result
London_1758_result
London_1841_result
eng_mort_result
HMD_UK_result
monks_result
```

## Mortality in the Wellcome dataset, pre-processed

```{r }
source("./lifetables_processing/stbrides_crypt.R")
source("./lifetables_processing/Merton_Priory.R")
source("./Wellcome_DB.R")
wellcome_result
```

# Supplements

## Minimum Gompertz beta in Coale/Demeny-Tables

```{r warning=FALSE}
source("../chapter_supplement/coale_demeny_life_tables_gompertz.R")
min(gompertz_df$Gompertz_shape)
```
