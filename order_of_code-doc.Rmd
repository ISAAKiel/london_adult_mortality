---
title: "Adult Mortality in the Metropolis of London 100–1850"
subtitle: "A Bayesian View from Osteological Data"
author: 
 - Nils Müller-Scheeßel^[Institute for Pre- and Proto History - Kiel University nils.mueller-scheessel@ufg.uni-kiel.de]
 - Katharina Fuchs^[Institute of Clinical Molecular Biology - Kiel University, k.fuchs@ikmb.uni-kiel.de]
 - Christoph Rinne^[Institute for Pre- and Proto History - Kiel University, crinne@ufg.uni-kiel.de]
date: "`r format(Sys.time(), '%d. %B %Y')`"
license: "CC-BY 4.0"
header-includes:
  #\renewcommand{\contentsname}{Inhalt}
  #\renewcommand{\figurename}{Abb.}
  #\renewcommand{\tablename}{Tab.}
papersize: a4
output:
  pdf_document:
    number_sections: true
    toc: true
    toc_depth: 2
    df_print: kable
    extra_dependencies: ["flafter"]
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 2
    toc_float: true
    number_sections: true
#  html_notebook:
#        code_folding: hide
knit rmdfig_caption: true
urlcolor: blue
link-citations: true # make citations hyperlinks
linkcolor: blue
---

```{r knitr global options, include=FALSE}
# Global options for knitr
knitr::opts_chunk$set(echo=TRUE, fig.align="center")
```

# Prerequisites {-}

Install required packages, set some options and link the sources for the helper functions. 

**Please note**: Relative paths in the original code, not for documentation purposes, references the workspace, e.g. "./helper_functions.R". Where as in Rmd-files the file location is the root for relative paths, e.g. "../helper_functions.R".  


```{r Packages and sources, echo=TRUE}
require(pacman) || install.packages("pacman")
pacman::p_load(dplyr, fitdistrplus, flexsurv, ggplot2, gridExtra, kableExtra,
               mortAAR, nlme, osmplotr, reshape2, rgdal, HMDHFDplus, Metrics,
               svMisc, tibble, tidyr, cowplot, MortalityLaws, rio,
               coda, rjags, runjags, demogR, sf, rnaturalearth, readxl,
               ggrepel)

options(scipen = 999)
options(dplyr.summarise.inform = FALSE)

source("./functions/bayes_cat_poisson.R")
source("./functions/gomp_MLE.R")
source("./functions/gomp_MLE_adapted.R")
source("./functions/gomp_MLE_interval.R")
source("./functions/gomp_anthr_age.R")
source("./functions/gomp_anthr_age_r.R")
source("./functions/gomp_bayes_known_age.R")
source("./functions/gomp_known_age_r.R")
source("./functions/helper_functions.R")
source("./functions/lt_MC.R")
source("./functions/lt_MC_Gomp.R")
RNGkind("L'Ecuyer-CMRG") # conservative random number generator to avoid periodicity
```
Important for saving time:  Decide to run extensive code anew (app. 6 h +). In addition, you can set the folder for preprocessed files.

```{r rund code anew, echo=TRUE}
runCodeNew <- FALSE
#runCodeNew <- TRUE

saveFileDir = "preprocessed_files"
if (saveFileDir %in% list.files(getwd())) 
 {}else{
	dir.create(file.path(".", saveFileDir), showWarnings = FALSE )
 }

```

The code makes extensive use of the function ```source``` to call external code. Thus the main part of the code remains slim, well structured and readable. 

Note: The base path for rmd files is the folder in which they are located. Consequently, order_of_code.R (code with comments) and order_of_code.RMD (information with code) are synchronous and are located in the base folder.

\newpage
# Chapter 01 Introduction

Figure 1: Gompertz.

```{r Fig. 1: Gompertz distribution, echo=TRUE, warning=FALSE}
source("./chapter_01_introduction/gompertz_distribution.R")
gridExtra::grid.arrange(gompertz_plot)
```

\newpage
# Chapter 02 Materials and methods

Figure 3 Hazard curve for HMD UK data of the year 1841.

```{r Fig. 3: Hazard curve, echo=TRUE, warning=FALSE}
source("./chapter_02_materials_and_methods/hazard_curve.R")
gridExtra::grid.arrange(HMD_UK_hazard_plot)
```

\newpage
# Chapter 03 Data

Figure 4 Major cemeteries in Greater London 1100–1850 used in the present study. 

```{r Fig. 4: Map of London, echo=TRUE, warning=FALSE}
source("./chapter_03_data/London_places.R") 
```

\newpage
Figure 5 Population development of London

```{r Fif. 5: Population development, echo=TRUE, warning=FALSE}
source("./chapter_03_data/London_population.R")
grid::grid.newpage()
grid::grid.draw(rbind(london_pop1, london_pop2))
```

Footnote 6  Re-calculation of rates for Razzell/Spence 2007
Calculated in ./chapter_03_data/London_population.R

```{r Footnote 6: Razzell/Spence 2007, warning=FALSE}
knitr::kable(razz_df, caption = "Re-calculation of rates for Razzell/Spence 2007")
```

\newpage
# Chapter 04 Results

## Historical life tables

### Written sources, pre-processed

Preprocessing of data used in figure 6: Estimated modal ages.

The data is referenced and aggregated in "./chapter_04_results/historical_lifetables.R". In this file, all records from individual preprocessing files located in "./liftables_preprocessed/" are ```sourced```.  The corresponding data files are stored in "./data/".

English_Peers.R, russell.txt \newline
```r read.delim("./data/russell.txt", sep = "|", header = F, nrows = 1)[1,1]```


```{r Tables with basic statistics of the preprocessed data, warning=FALSE}
source("./chapter_04_results/historical_lifetables.R")
kable(peers_ranges, 
      caption = "English Peers")
```

kable(monks_ranges, 
      caption = "Christ Church monks (Medieval England.R)")
kable(london_1728_1840_ranges, 
      caption = "London population, range of age modes M (London 1728 1840.R)")
kable(london_1728_1840_ranges_r, 
      caption = "London population, range of rate (London 1728 1840.R)")
kable(London_1841_ranges, 
      caption = "London population (London 1841 raw all.R)")
kable(eng_mort_ranges, 
      caption = "English data (Wrigley et al. 1997) (English Mortality.R)")
kable(HMD_UK_ranges, 
      caption = "Human Mortality Database UK (HMD UK.R)")



